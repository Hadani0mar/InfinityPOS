name: Auto Update System

on:
  push:
    branches: [ master ]
  release:
    types: [ published ]

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build --configuration Release --no-restore
    
    - name: Publish Single File
      run: dotnet publish --configuration Release --output ./publish --no-build -r win-x64 --self-contained true /p:PublishSingleFile=true
    
    - name: Create Release Package
      run: |
        # إنشاء ملف ZIP للتحديث
        Compress-Archive -Path "./publish/*" -DestinationPath "./SmartInventoryPro_Update.zip" -Force
        
        # إنشاء ملف معلومات التحديث
        $version = (Get-Content "./InfinityPOS.csproj" | Select-String "Version" | ForEach-Object { $_.Line -replace '.*Version>([^<]+)<.*', '$1' })
        $commitMessage = "${{ github.event.head_commit.message }}"
        $updateInfo = @{
          version = $version
          date = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
          message = $commitMessage
          commit_hash = "${{ github.sha }}"
          download_url = "https://github.com/${{ github.repository }}/releases/latest/download/SmartInventoryPro_Update.zip"
        } | ConvertTo-Json
        
        $updateInfo | Out-File -FilePath "./update_info.json" -Encoding UTF8
    
    - name: Upload Release Assets
      uses: actions/upload-artifact@v4
      with:
        name: SmartInventoryPro_Update
        path: |
          SmartInventoryPro_Update.zip
          update_info.json
    
    - name: Create Release
      if: github.event_name == 'push'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ github.run_number }}
        name: SmartInventory Pro v${{ github.run_number }}
        body: |
          ## تحديث تلقائي
          
          - **الإصدار**: v${{ github.run_number }}
          - **التاريخ**: ${{ github.event.head_commit.timestamp }}
          - **الرسالة**: ${{ github.event.head_commit.message }}
          
          ### الميزات الجديدة:
          - تحسينات في الأداء
          - إصلاح الأخطاء
          - ميزات جديدة
          
          ### كيفية التحديث:
          1. اضغط على زر "🔄 التحديثات" في التطبيق
          2. أو انتظر التحديث التلقائي عند بدء التطبيق
        files: |
          SmartInventoryPro_Update.zip
          update_info.json
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
