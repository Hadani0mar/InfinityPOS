name: Auto Update System

on:
  push:
    branches: [ master ]
  release:
    types: [ published ]

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build --configuration Release --no-restore
    
    - name: Publish Single File
      run: dotnet publish --configuration Release --output ./publish --no-build -r win-x64 --self-contained true /p:PublishSingleFile=true
    
    - name: Create Release Package
      run: |
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ZIP Ù„Ù„ØªØ­Ø¯ÙŠØ«
        Compress-Archive -Path "./publish/*" -DestinationPath "./SmartInventoryPro_Update.zip" -Force
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«
        $version = (Get-Content "./InfinityPOS.csproj" | Select-String "Version" | ForEach-Object { $_.Line -replace '.*Version>([^<]+)<.*', '$1' })
        $commitMessage = "${{ github.event.head_commit.message }}"
        $updateInfo = @{
          version = $version
          date = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
          message = $commitMessage
          commit_hash = "${{ github.sha }}"
          download_url = "https://github.com/${{ github.repository }}/releases/latest/download/SmartInventoryPro_Update.zip"
        } | ConvertTo-Json
        
        $updateInfo | Out-File -FilePath "./update_info.json" -Encoding UTF8
    
    - name: Upload Release Assets
      uses: actions/upload-artifact@v4
      with:
        name: SmartInventoryPro_Update
        path: |
          SmartInventoryPro_Update.zip
          update_info.json
    
    - name: Create Release
      if: github.event_name == 'push'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ github.run_number }}
        name: SmartInventory Pro v${{ github.run_number }}
        body: |
          ## ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ
          
          - **Ø§Ù„Ø¥ØµØ¯Ø§Ø±**: v${{ github.run_number }}
          - **Ø§Ù„ØªØ§Ø±ÙŠØ®**: ${{ github.event.head_commit.timestamp }}
          - **Ø§Ù„Ø±Ø³Ø§Ù„Ø©**: ${{ github.event.head_commit.message }}
          
          ### Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:
          - ØªØ­Ø³ÙŠÙ†Ø§Øª ÙÙŠ Ø§Ù„Ø£Ø¯Ø§Ø¡
          - Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
          - Ù…ÙŠØ²Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
          
          ### ÙƒÙŠÙÙŠØ© Ø§Ù„ØªØ­Ø¯ÙŠØ«:
          1. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "ðŸ”„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª" ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
          2. Ø£Ùˆ Ø§Ù†ØªØ¸Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        files: |
          SmartInventoryPro_Update.zip
          update_info.json
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
