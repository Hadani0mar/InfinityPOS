name: Auto Update System

on:
  push:
    branches: [ master ]
  release:
    types: [ published ]

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build --configuration Release --no-restore
    
    - name: Publish Single File
      run: dotnet publish --configuration Release --output ./publish --no-build -r win-x64 --self-contained true /p:PublishSingleFile=true
    
    - name: Create Release Package
      run: |
        # Ù†Ø³Ø® Ù…Ù„Ù appsettings.json Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ publish
        Copy-Item "./appsettings.json" "./publish/appsettings.json" -Force
        
        # Ù†Ø³Ø® Ù…Ù„Ù README Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ publish
        Copy-Item "./DOWNLOAD_FROM_GITHUB.md" "./publish/README.md" -Force
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ dist Ù„Ù„Ù…Ø«Ø¨Øª
        New-Item -ItemType Directory -Path "./dist" -Force
        New-Item -ItemType Directory -Path "./dist/publish" -Force
        
        # Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¥Ù„Ù‰ dist
        Copy-Item "./publish/*" "./dist/publish/" -Recurse -Force
        Copy-Item "./appsettings.json" "./dist/" -Force
        Copy-Item "./DOWNLOAD_FROM_GITHUB.md" "./dist/" -Force
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø«Ø¨Øª
        $installerContent = @"
@echo off
chcp 65001 >nul
title SmartInventory Pro Installer v1.5.1
echo.
echo ========================================
echo    SmartInventory Pro Installer v1.5.1
echo ========================================
echo.
echo Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ SmartInventory Pro
echo.
echo Ø³ÙŠÙ‚ÙˆÙ… Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ Ø¨ØªØ«Ø¨ÙŠØª SmartInventory Pro Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.
echo SmartInventory Pro Ù‡Ùˆ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø£Ø¹Ù…Ø§Ù„ Ù…ØªÙ‚Ø¯Ù… ÙŠÙˆÙØ± Ø¥Ø¯Ø§Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª.
echo.
set "APP_NAME=SmartInventory Pro"
set "APP_DIR=%PROGRAMFILES%\%APP_NAME%"
set "START_MENU=%APPDATA%\Microsoft\Windows\Start Menu\Programs"
echo [INFO] ØªØ«Ø¨ÙŠØª %APP_NAME%...
echo.
if not exist "%APP_DIR%" mkdir "%APP_DIR%"
REM Check if application is already installed
if exist "%APP_DIR%\SmartInventoryPro.exe" (
    echo [INFO] ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥ØµØ¯Ø§Ø± Ù…Ø«Ø¨Øª Ù…Ø³Ø¨Ù‚Ø§Ù‹
    echo [INFO] Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...
    echo.
    REM Stop running application
    taskkill /f /im SmartInventoryPro.exe 2>nul
    timeout /t 2 /nobreak >nul
)
echo [INFO] Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...
xcopy "publish\*" "%APP_DIR%\" /Y /E /I
REM Only copy appsettings.json if it doesn't exist (preserve user settings)
if not exist "%APP_DIR%\appsettings.json" (
    if exist "appsettings.json" copy "appsettings.json" "%APP_DIR%\" >nul
    echo [INFO] ØªÙ… Ù†Ø³Ø® Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
) else (
    echo [INFO] ØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
)
echo [SUCCESS] ØªÙ… Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
echo [INFO] Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØµØ§Ø±Ø§Øª...
powershell -Command "$WshShell = New-Object -comObject WScript.Shell; $Shortcut = $WshShell.CreateShortcut('%START_MENU%\%APP_NAME%.lnk'); $Shortcut.TargetPath = '%APP_DIR%\SmartInventoryPro.exe'; $Shortcut.WorkingDirectory = '%APP_DIR%'; $Shortcut.Description = 'SmartInventory Pro'; $Shortcut.Save()" 2>nul
set "DESKTOP_SHORTCUT=%USERPROFILE%\Desktop\%APP_NAME%.lnk"
powershell -Command "$WshShell = New-Object -comObject WScript.Shell; $Shortcut = $WshShell.CreateShortcut('%DESKTOP_SHORTCUT%'); $Shortcut.TargetPath = '%APP_DIR%\SmartInventoryPro.exe'; $Shortcut.WorkingDirectory = '%APP_DIR%'; $Shortcut.Description = 'SmartInventory Pro'; $Shortcut.Save()" 2>nul
echo.
echo ========================================
if exist "%APP_DIR%\SmartInventoryPro.exe" (
    echo    ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­!
) else (
    echo    ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¨Ù†Ø¬Ø§Ø­!
)
echo ========================================
echo.
echo ØªÙ… ØªØ«Ø¨ÙŠØª/ØªØ­Ø¯ÙŠØ« %APP_NAME% ÙÙŠ: %APP_DIR%
echo ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØµØ§Ø±Ø§Øª ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ø¨Ø¯Ø£ ÙˆØ³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨
echo.
echo Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙƒ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
echo.
echo Ø§Ø¶ØºØ· Ø£ÙŠ Ù…ÙØªØ§Ø­ Ù„Ù„Ø®Ø±ÙˆØ¬...
pause >nul
"@
        $installerContent | Out-File -FilePath "./dist/SmartInventoryPro_Setup_v1.5.1.exe" -Encoding UTF8
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ZIP Ù„Ù„ØªØ­Ø¯ÙŠØ«
        Compress-Archive -Path "./publish/*" -DestinationPath "./SmartInventoryPro_Update.zip" -Force
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ZIP Ù„Ù„Ù…Ø«Ø¨Øª
        Compress-Archive -Path "./dist/*" -DestinationPath "./SmartInventoryPro_Installer.zip" -Force
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«
        $version = (Get-Content "./InfinityPOS.csproj" | Select-String "Version" | ForEach-Object { $_.Line -replace '.*Version>([^<]+)<.*', '$1' })
        $commitMessage = "${{ github.event.head_commit.message }}"
        $updateInfo = @{
          version = $version
          date = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
          message = $commitMessage
          commit_hash = "${{ github.sha }}"
          download_url = "https://github.com/${{ github.repository }}/releases/latest/download/SmartInventoryPro_Update.zip"
        } | ConvertTo-Json
        
        $updateInfo | Out-File -FilePath "./update_info.json" -Encoding UTF8
    
    - name: Upload Release Assets
      uses: actions/upload-artifact@v4
      with:
        name: SmartInventoryPro_Update
        path: |
          SmartInventoryPro_Update.zip
          SmartInventoryPro_Installer.zip
          update_info.json
    
    - name: Create Release
      if: github.event_name == 'push'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v1.5.2
        name: SmartInventory Pro v1.5.2
        body: |
          ## ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ
          
          - **Ø§Ù„Ø¥ØµØ¯Ø§Ø±**: v1.5.2
          - **Ø§Ù„ØªØ§Ø±ÙŠØ®**: ${{ github.event.head_commit.timestamp }}
          - **Ø§Ù„Ø±Ø³Ø§Ù„Ø©**: ${{ github.event.head_commit.message }}
          
          ### Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:
          - ØªØ­Ø³ÙŠÙ†Ø§Øª ÙÙŠ Ø§Ù„Ø£Ø¯Ø§Ø¡
          - Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
          - Ù…ÙŠØ²Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
          
          ### ÙƒÙŠÙÙŠØ© Ø§Ù„ØªØ«Ø¨ÙŠØª:
          1. **Ù„Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¬Ø¯ÙŠØ¯**: Ù†Ø²Ù„ `SmartInventoryPro_Installer.zip` ÙˆØ§Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ø¶ØºØ· Ø¹Ù„Ù‰ `SmartInventoryPro_Setup_v1.5.1.exe`
          2. **Ù„Ù„ØªØ­Ø¯ÙŠØ«**: Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "ðŸ”„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª" ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø£Ùˆ Ø§Ù†ØªØ¸Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
          
          ### Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ v1.5.1:
          - âœ… Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ù‡Ø¨ ðŸ”¥ ÙÙˆÙ‚ "Ø£ÙØ¶Ù„ Ù…Ù†ØªØ¬" Ùˆ "Ø£ÙØ¶Ù„ ÙØ¦Ø©"
          - âœ… ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¨ØµØ±ÙŠØ© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
          - âœ… Ù…Ø«Ø¨Øª Ù…Ø­Ø³Ù† Ù…Ø¹ ÙˆØ§Ø¬Ù‡Ø© Ø³Ù‡Ù„Ø©
          - âœ… Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
        files: |
          SmartInventoryPro_Update.zip
          SmartInventoryPro_Installer.zip
          update_info.json
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
