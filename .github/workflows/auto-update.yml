name: Auto Update System

on:
  push:
    branches: [ master ]
    tags: [ 'v*' ]
  release:
    types: [ published ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Debug Info
      run: |
        echo "Event name: ${{ github.event_name }}"
        echo "Ref: ${{ github.ref }}"
        echo "Ref name: ${{ github.ref_name }}"
        echo "Ref type: ${{ github.ref_type }}"
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build --configuration Release --no-restore
    
    - name: Publish Single File
      run: dotnet publish --configuration Release --output ./publish --no-build -r win-x64 --self-contained true /p:PublishSingleFile=true
    
    - name: Create Release Package
      run: |
        # Copy appsettings.json to publish directory
        Copy-Item "./appsettings.json" "./publish/appsettings.json" -Force
        
        # Copy README to publish directory
        Copy-Item "./DOWNLOAD_FROM_GITHUB.md" "./publish/README.md" -Force
        
        # Create dist directory for installer
        New-Item -ItemType Directory -Path "./dist" -Force
        New-Item -ItemType Directory -Path "./dist/publish" -Force
        
        # Copy application files to dist
        Copy-Item "./publish/*" "./dist/publish/" -Recurse -Force
        Copy-Item "./appsettings.json" "./dist/" -Force
        Copy-Item "./DOWNLOAD_FROM_GITHUB.md" "./dist/" -Force
        
        # Create installer
        $installerContent = @"
@echo off
chcp 65001 >nul
title SmartInventory Pro Installer v1.5.1
echo.
echo ========================================
echo    SmartInventory Pro Installer v1.5.1
echo ========================================
echo.
echo مرحباً بك في SmartInventory Pro
echo.
echo سيقوم هذا المعالج بتثبيت SmartInventory Pro على جهازك.
echo SmartInventory Pro هو نظام إدارة أعمال متقدم يوفر إدارة شاملة للمخزون والمبيعات.
echo.
set "APP_NAME=SmartInventory Pro"
set "APP_DIR=%PROGRAMFILES%\%APP_NAME%"
set "START_MENU=%APPDATA%\Microsoft\Windows\Start Menu\Programs"
echo [INFO] تثبيت %APP_NAME%...
echo.
if not exist "%APP_DIR%" mkdir "%APP_DIR%"
REM Check if application is already installed
if exist "%APP_DIR%\SmartInventoryPro.exe" (
    echo [INFO] تم العثور على إصدار مثبت مسبقاً
    echo [INFO] سيتم تحديث التطبيق...
    echo.
    REM Stop running application
    taskkill /f /im SmartInventoryPro.exe 2>nul
    timeout /t 2 /nobreak >nul
)
echo [INFO] نسخ ملفات التطبيق...
xcopy "publish\*" "%APP_DIR%\" /Y /E /I
REM Only copy appsettings.json if it doesn't exist (preserve user settings)
if not exist "%APP_DIR%\appsettings.json" (
    if exist "appsettings.json" copy "appsettings.json" "%APP_DIR%\" >nul
    echo [INFO] تم نسخ ملف الإعدادات الافتراضي
) else (
    echo [INFO] تم الاحتفاظ بإعدادات المستخدم الموجودة
)
echo [SUCCESS] تم نسخ ملفات التطبيق
echo [INFO] إنشاء اختصارات...
powershell -Command "$WshShell = New-Object -comObject WScript.Shell; $Shortcut = $WshShell.CreateShortcut('%START_MENU%\%APP_NAME%.lnk'); $Shortcut.TargetPath = '%APP_DIR%\SmartInventoryPro.exe'; $Shortcut.WorkingDirectory = '%APP_DIR%'; $Shortcut.Description = 'SmartInventory Pro'; $Shortcut.Save()" 2>nul
set "DESKTOP_SHORTCUT=%USERPROFILE%\Desktop\%APP_NAME%.lnk"
powershell -Command "$WshShell = New-Object -comObject WScript.Shell; $Shortcut = $WshShell.CreateShortcut('%DESKTOP_SHORTCUT%'); $Shortcut.TargetPath = '%APP_DIR%\SmartInventoryPro.exe'; $Shortcut.WorkingDirectory = '%APP_DIR%'; $Shortcut.Description = 'SmartInventory Pro'; $Shortcut.Save()" 2>nul
echo.
echo ========================================
if exist "%APP_DIR%\SmartInventoryPro.exe" (
    echo    تم التحديث بنجاح!
) else (
    echo    تم التثبيت بنجاح!
)
echo ========================================
echo.
echo تم تثبيت/تحديث %APP_NAME% في: %APP_DIR%
echo تم إنشاء اختصارات في قائمة ابدأ وسطح المكتب
echo.
echo ملاحظة: تم الاحتفاظ بإعداداتك المحفوظة
echo.
echo اضغط أي مفتاح للخروج...
pause >nul
"@
        $installerContent | Out-File -FilePath "./dist/SmartInventoryPro_Setup_v1.5.1.exe" -Encoding UTF8
        
        # Create update ZIP file
        Compress-Archive -Path "./publish/*" -DestinationPath "./SmartInventoryPro_Update.zip" -Force
        
        # Create installer ZIP file
        Compress-Archive -Path "./dist/*" -DestinationPath "./SmartInventoryPro_Installer.zip" -Force
        
        # Create update info file
        $version = (Get-Content "./InfinityPOS.csproj" | Select-String "Version" | ForEach-Object { $_.Line -replace '.*Version>([^<]+)<.*', '$1' })
        $commitMessage = "${{ github.event.head_commit.message }}"
        $updateInfo = @{
          version = $version
          date = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
          message = $commitMessage
          commit_hash = "${{ github.sha }}"
          download_url = "https://github.com/${{ github.repository }}/releases/latest/download/SmartInventoryPro_Update.zip"
        } | ConvertTo-Json
        
        $updateInfo | Out-File -FilePath "./update_info.json" -Encoding UTF8
    
    - name: Upload Release Assets
      uses: actions/upload-artifact@v4
      with:
        name: SmartInventoryPro_Update
        path: |
          SmartInventoryPro_Update.zip
          SmartInventoryPro_Installer.zip
          update_info.json
    
    - name: Create Release
      if: github.ref_type == 'tag'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: SmartInventory Pro ${{ github.ref_name }}
        body: |
          ## تحديث تلقائي
          
          - **الإصدار**: ${{ github.ref_name }}
          - **التاريخ**: ${{ github.event.head_commit.timestamp }}
          - **الرسالة**: ${{ github.event.head_commit.message }}
          
          ### الميزات الجديدة:
          - تحسينات في الأداء
          - إصلاح الأخطاء
          - ميزات جديدة
          
          ### كيفية التثبيت:
          1. **للتثبيت الجديد**: نزل `SmartInventoryPro_Installer.zip` واستخرج الملفات واضغط على `SmartInventoryPro_Setup_v1.5.1.exe`
          2. **للتحديث**: اضغط على زر "🔄 التحديثات" في التطبيق أو انتظر التحديث التلقائي
          
          ### الميزات الجديدة في v1.5.1:
          - ✅ أيقونة لهب 🔥 فوق "أفضل منتج" و "أفضل فئة"
          - ✅ تحسينات بصرية للواجهة
          - ✅ مثبت محسن مع واجهة سهلة
          - ✅ إصلاحات أخطاء التحديثات
        files: |
          SmartInventoryPro_Update.zip
          SmartInventoryPro_Installer.zip
          update_info.json
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
